<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PayPal SDK SandBox</title>
    <script>
      // Function to extract query string parameters from URL
      function getQueryParams(url) {
        var queryParams = {};
        var params = url.slice(url.indexOf("?") + 1).split("&");

        for (var i = 0; i < params.length; i++) {
          var param = params[i].split("=");
          var key = decodeURIComponent(param[0]);
          var value = decodeURIComponent(param[1] || "");
          queryParams[key] = value;
        }

        return queryParams;
      }

      // Function to read query string when the page loads
      function readQueryString() {
        var url = window.location.search;
        var queryParams = getQueryParams(url);

        // Accessing individual query parameters
        var giv_id = queryParams["giv_id"];
        var amount = queryParams["amount"];

        // Do something with the query parameters
        console.log("giv_id:", giv_id);
        console.log("amount:", amount);
        //save to local storage
        localStorage.setItem("giv_id", giv_id);
        localStorage.setItem("amount", amount);
        //remove from url
        window.history.replaceState({}, document.title, "/");

      }
    </script>
  </head>
  <body onload="readQueryString()">
    <script data-sdk-integration-source="integrationbuilder_sc"></script>
    <div id="paypal-button-container"></div>
    <script src="https://www.paypal.com/sdk/js?client-id=AVkuImsa0vaRKpsqeYRuq7MvW9oaaTM-sZwiZ8dTz4llFyUVEXoLh9mSghcpbDRT8dUSEXAiOEPOyRic&currency=CAD"></script>
    <script>
      paypal
        .Buttons({
          createOrder: async (data, actions) => {
            // This function sets up the details of the transaction, including the amount and giv_id.
            const giv_id = localStorage.getItem("giv_id");
            const amount = localStorage.getItem("amount");
            const response = await fetch(`/orders?giv_id=${giv_id}&amount=${amount}`, {
              method: "POST",
            });
            const details = await response.json();
            return details.id;
          },
          onApprove: async (data, actions) => {
            const response = await fetch(`/orders/${data.orderID}/capture`, {
              method: "POST",
            });
            const details = await response.json();
            // Three cases to handle:
            //   (1) Recoverable INSTRUMENT_DECLINED -> call actions.restart()
            //   (2) Other non-recoverable errors -> Show a failure message
            //   (3) Successful transaction -> Show confirmation or thank you

            // This example reads a v2/checkout/orders capture response, propagated from the server
            // You could use a different API or structure for your 'orderData'

            const errorDetail =
              Array.isArray(details.details) && details.details[0];
            if (errorDetail && errorDetail.issue === "INSTRUMENT_DECLINED") {
              return actions.restart(); // Recoverable state, per:
              // https://developer.paypal.com/docs/checkout/integration-features/funding-failure/
            }

            if (errorDetail) {
              let msg = "Sorry, your transaction could not be processed.";
              if (errorDetail.description)
                msg += "\n\n" + errorDetail.description;
              if (details.debug_id) msg += " (" + details.debug_id + ")";
              return alert(msg); // Show a failure message (try to avoid alerts in production environments)
            }

            // Successful capture! For demo purposes:
            console.log(
              "Capture result",
              details,
              JSON.stringify(details, null, 2)
            );
            const transaction = details.purchase_units[0].payments.captures[0];
            alert(
              "Transaction " +
                transaction.status +
                ": " +
                transaction.id +
                "\n\nSee console for all available details"
            );
          },
        })
        .render("#paypal-button-container");
    </script>
  </body>
</html>
